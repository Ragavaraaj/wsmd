name: WSMD Build and Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  build-main-executable:
    name: Build Main Executable
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build executable with PyInstaller
        run: |
          pyinstaller wsmd.spec

      - name: Upload executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wsmd-executable
          path: dist/wsmd.exe
          retention-days: 30 # Artifact will be available for 30 days

  build-dashboard-executable:
    name: Build Dashboard Executable
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Build dashboard executable with PyInstaller
        run: |
          cd ${{ github.workspace }}
          dir dashboard
          pyinstaller --onefile --clean --windowed --name wsmd_dashboard dashboard/main.py

      - name: Upload dashboard executable as artifact
        uses: actions/upload-artifact@v4
        with:
          name: wsmd-dashboard-executable
          path: dist/wsmd_dashboard.exe
          retention-days: 30 # Artifact will be available for 30 days

  create-release:
    name: Create GitHub Release
    needs: [build-main-executable, build-dashboard-executable]
    if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    steps:
      - name: Check for recent releases
        id: check_releases
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if a release was created in the last 5 minutes
            const date = new Date();
            date.setMinutes(date.getMinutes() - 5);
            const since = date.toISOString();

            console.log(`Checking for releases created since ${since}`);

            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 10
            });

            if (releases.data.length > 0) {
              const recentRelease = releases.data[0];
              console.log(`Most recent release: ${recentRelease.tag_name} created at ${recentRelease.created_at}`);
              
              const releaseDate = new Date(recentRelease.created_at);
              if (releaseDate > date) {
                console.log(`Found recent release: ${recentRelease.tag_name}`);
                return 'skip';
              }
            }

            return 'create';
          result-encoding: string

      - name: Download main executable artifact
        if: steps.check_releases.outputs.result == 'create'
        uses: actions/download-artifact@v4
        with:
          name: wsmd-executable
          path: artifacts/main

      - name: Download dashboard executable artifact
        if: steps.check_releases.outputs.result == 'create'
        uses: actions/download-artifact@v4
        with:
          name: wsmd-dashboard-executable
          path: artifacts/dashboard

      - name: List downloaded artifacts
        if: steps.check_releases.outputs.result == 'create'
        run: |
          echo "Downloaded artifacts:"
          find artifacts -type f | sort

      - name: Validate downloaded artifacts
        if: steps.check_releases.outputs.result == 'create'
        id: validate_artifacts
        run: |
          # Check if we have both executables
          if [ ! -f "artifacts/main/wsmd.exe" ]; then
            echo "::error::Missing main executable (wsmd.exe)"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          elif [ ! -f "artifacts/dashboard/wsmd_dashboard.exe" ]; then
            echo "::error::Missing dashboard executable (wsmd_dashboard.exe)"
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "Both executables found!"
            echo "proceed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create release directory
        if: steps.check_releases.outputs.result == 'create' && steps.validate_artifacts.outputs.proceed == 'true'
        run: |
          mkdir -p release-files

      - name: Copy artifacts to release directory
        if: steps.check_releases.outputs.result == 'create' && steps.validate_artifacts.outputs.proceed == 'true'
        run: |
          # Copy executables to release directory
          cp artifacts/main/wsmd.exe release-files/
          cp artifacts/dashboard/wsmd_dashboard.exe release-files/
          
          echo "Release files:"
          ls -la release-files/

      - name: Create release tag
        if: steps.check_releases.outputs.result == 'create' && steps.validate_artifacts.outputs.proceed == 'true'
        id: create_tag
        run: |
          # Generate a tag based on the date and time
          TAG="v$(date +'%Y.%m.%d-%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        if: steps.check_releases.outputs.result == 'create' && steps.validate_artifacts.outputs.proceed == 'true'
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.create_tag.outputs.tag }}
          name: WSMD Release ${{ steps.create_tag.outputs.tag }}
          body: |
            Automated release of WSMD executables

            This release contains:
            - WSMD Server application (wsmd.exe)
            - WSMD Dashboard application (wsmd_dashboard.exe)
            
            Both executables are standalone and do not require installation.
            
            ## Server Application
            The WSMD Server provides a web interface for device management.
            Run wsmd.exe to start the server on port 8000.
            
            ## Dashboard Application
            The WSMD Dashboard provides a dedicated display of device status.
            Run wsmd_dashboard.exe to launch the dashboard.
            
            ---
            Built from commit: ${{ github.sha }}
            Release date: $(date +'%Y-%m-%d %H:%M:%S UTC')
          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
